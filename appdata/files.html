<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="/___vscode_livepreview_injected_script"></script>
	<title>Files app</title>
	<meta name="description" content="Default Files app for Nova OS">
	<meta name="nova-icon"
		content="<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='115.79063' height='79.42629' viewBox='0,0,115.79063,79.42629'><g transform='translate(-182.26576,-138.78469)'><g data-paper-data='{&quot;isPaintingLayer&quot;:true}' fill-rule='nonzero' stroke-linecap='butt' stroke-linejoin='miter' stroke-miterlimit='10' stroke-dasharray='' stroke-dashoffset='0' style='mix-blend-mode: normal'><path d='M192.5,211v-70.66666h96.33333v70.66666z' fill='#5e511c' stroke='none' stroke-width='0'/><path d='M214.94361,194.01973l7.87476,-55.19191l75.23803,10.73494l-7.87476,55.19191z' fill='#cbcbcb' stroke='none' stroke-width='0'/><path d='M215.52729,204.79778l-7.94546,-55.18178l75.22422,-10.83131l7.94545,55.18177z' fill='#ffffff' stroke='none' stroke-width='0'/><path d='M191.80875,211.01003l-9.54298,-67.4916c0,0 17.94997,0 29.05001,0c1.75099,0 3.83004,5.47155 6.1555,5.47155c21.27569,0 63.17701,0 63.17701,0l7.54298,62.02005z' fill='#ffe166' stroke='none' stroke-width='0'/><path d='M217.66762,213.21099c-0.25148,-4.40441 -2.40197,-12.90365 1.84715,-16.36796c3.99005,-3.25308 24.23976,-3.39012 28.02687,0.40735c3.79805,3.80844 6.43466,11.61379 6.49657,16.10718' fill='none' stroke='#00b8ff' stroke-width='10'/></g></g></svg>">
	<script src="https://cdn.jsdelivr.net/npm/jsmediatags@latest/dist/jsmediatags.min.js"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300&display=swap');

		/* width */
		::-webkit-scrollbar {
			width: 0.5em;
		}

		/* Track */
		::-webkit-scrollbar-track {
			background: #101010;
		}

		/* Handle */
		::-webkit-scrollbar-thumb {
			background: #2b2b2b;
			border-radius: 5px;
		}

		/* Handle on hover */
		::-webkit-scrollbar-thumb:hover {
			background: #555;
		}

		html {
			height: 100%;
		}

		body {
			height: 100%;
			margin: 0;
			padding: 0;
			font-family: 'Poppins', sans-serif;
			color: white;
			user-select: none;
		}

		#flap-mot {
			display: block;
			box-sizing: border-box;
			overflow: hidden;
			background-color: #0e0e0e;
			height: calc(100% - 0px);
		}

		[flap-nav] y {
			display: flex;
			background-color: #151515;
			width: 100%;
			flex-direction: row;
			flex-wrap: nowrap;
			align-items: center;
		}

		[flap-nav] {
			display: flex;
			height: 29px;
			flex-direction: row;
			flex-wrap: nowrap;
			padding: 3px;
			padding-bottom: 0;
		}

		.flappsearch {
			flex-grow: 10 !important;
			text-align: center !important;
			font-size: 11px;
			color: #b8b8b8;
			display: grid;
			align-items: center;
		}

		.nowid {
			width: fit-content;
			text-align: center;
			backdrop-filter: brightness(1.7);
			display: flex;
			justify-content: center;
			align-items: center;
			border: none;
			overflow: hidden;
			border-radius: 0.5rem;
			margin: 0.1rem;
			padding: 16px 0;
		}

		.navbfobtns {
			width: fit-content;
			flex: 0;
			margin: 1rem;
		}

		.navinfobtns:active {
			transform: rotate(360deg);
		}

		.sdfld {
			width: 90%;
			margin: auto;
			margin-bottom: 3px;
			background: #151515;
			border-radius: 5px;
			text-align: left;
			overflow: hidden;
			transition: 0.3s;
			text-overflow: ellipsis;
			white-space: nowrap;
			padding: 3px;
			cursor: pointer;
		}

		.sdfld:hover {
			background-color: #2f2f2f;
		}

		.sdfld span {
			font-size: 15px;
			transform: translate(1px, 3px);
			margin-right: 6px;
			color: #fff996;
		}

		[flap-sidenav] {
			width: 0;
			overflow-y: scroll;
			font-size: 11px !important;
			min-width: 120px;
			background: #161616;
			padding-bottom: 50px;
			display: flex;
			flex-direction: column;
			transition: .3s;
			border-radius: 0.5rem;
			overflow-x: hidden;
			height: calc(100% - 51px);
		}

		[flap-sidenav] small {
			padding-left: 5px;
		}

		.themainstuff {
			margin: 10px 5px;
			display: flex;
			width: 100%;
			height: 100%;
		}

		[flap-fl-topnav] {
			display: flex;
			padding-top: 0.5rem;
			margin: 0rem 0.5rem;
			margin-bottom: 0.1rem;
			font-size: 9px;
			opacity: 70%;
			flex-direction: row;
			background-color: #181818;
			border-radius: 0.3rem;
		}

		[flap-files] {
			overflow-y: scroll;
			flex-grow: 8;
			padding-bottom: 50px !important;
			padding: 10px;
			width: calc(100% - 28px);
			padding-top: 0;
			margin-top: 5px;
		}

		.file {
			background: #1c1c1c;
			user-select: none;
			border-radius: 7px;
			transition: .3s;
			animation: poprs .2s ease-out;
		}

		.file[list] {
			display: flex;
			padding: 0.1rem 0.5rem;
			margin-bottom: 0.2rem;
			flex-direction: row;
			flex-wrap: nowrap;
			align-items: center;
			justify-content: flex-start;
		}


		.file[list] .flfrname {
			width: calc(100% - 73px);
			display: inline-block;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.file[grid] {
			display: inline-block;
			height: 83px;
			width: calc(50% - 42px);
			min-width: 80px;
			margin: 5px;
			transition: .3s;
			padding: 1rem;
			max-width: 100px;
		}

		.file[grid] .flfrname {
			max-width: 66px;
			text-overflow: ellipsis;
			overflow: hidden;
		}

		.file[list] small {
			width: auto;
			transform: none;
			font-family: monospace;
			opacity: 0.3;
		}

		@keyframes poprs {
			from {
				opacity: 0;
				transform: translateY(-10px);
			}

			to {
				opacity: 1;
				transform: translateY(0px);
			}
		}

		.file:hover {
			background: #373737;
		}

		.file small {
			float: right;
			flex-basis: max-content;
			display: inline-block;
			transform: translate(-3px, 4px);
			opacity: 0.5;
			font-size: 11px;
			width: 0;
			overflow: hidden;
			text-overflow: ellipsis;
			flex-grow: 5;
			text-align: end;

			margin-left: 0.2rem;
		}

		.file[grid]>[flname] {
			font-size: 14px;
			display: flex;
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
			margin: 0;
			position: relative;
			width: 100%;
			background: #252525;
			padding: 10px;
			border-radius: 5px;
			transform: translate(-10px, 10px);
			transition: 0.2s;
			flex-direction: row;
			flex-wrap: nowrap;
			justify-content: flex-start;
		}

		.file[grid]>[flname] [flfrname] {
			width: 0;
			display: inline-block;
			overflow: hidden;
			text-overflow: ellipsis;
			flex-grow: 8;
			margin-right: 10px;
		}

		.file[list]>[flname] {
			font-size: 14px;
			display: flex;
			width: 0;
			flex: 1;
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
			margin: 0;
			align-items: center;
		}

		.file span .material-symbols-rounded {
			color: #7193ff;
			text-shadow: 0 0 1rem inherit;
		}

		.file[list] span .material-symbols-rounded {
			width: fit-content;
			margin-left: 0;
			transform: translate(-1px, 0px) scale(0.8);
		}

		.file[list] span {
			width: 22px;
			overflow: hidden;
			display: grid;
			margin-right: 3px;
			align-items: center;
			justify-items: center;
		}

		.file[grid] span .material-symbols-rounded {
			font-size: 41px;
			display: block;
		}

		#slfile {
			background: #414e59;
			transform: scale(1.01);
		}

		#slfile[grid] [flname] {
			background: #566877;
		}

		[bottomnav] {
			width: 100%;
			text-align: left;
			border: 1px solid;
			padding: 3px 5px;
			font-size: 14px;
		}

		[flap-fl-bottomnav] {
			padding: 5px 7px;
			background: #161616;
			border-radius: 0.3rem;
			font-size: 12px;
			transition: .3s ease-out;
			margin: 0.2rem;
			width: calc(100% - 25px);
		}

		.delbtn {
			background: #1f1f1f;
			border: none;
			border-radius: 10px;
			color: #ff7c7c;
			margin: 0px 10px;
			float: right;
			transition: .2s;
			padding: 2px 8px;
			cursor: pointer;
		}

		.delbtn:hover {
			background-color: #442a2a;
		}

		.delbtn span {
			font-size: 10px;
			transform: translate(0px, 1px) scale(1.3);
		}

		input[type="file"] {
			outline: none;
			width: 252px;
			margin: auto;
			display: block;
			position: relative;
			overflow: scroll;
		}

		input[type="file"]::file-selector-button {
			width: 135px;
			color: transparent;
		}

		/* Faked label styles and icon */
		input[type="file"]::before {
			position: absolute;
			pointer-events: none;
			top: 7px;
			left: 16px;
			filter: brightness(200%);
			height: 20px;
			width: 20px;
			content: "";
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%230964B0'%3E%3Cpath d='M18 15v3H6v-3H4v3c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-3h-2zM7 9l1.41 1.41L11 7.83V16h2V7.83l2.59 2.58L17 9l-5-5-5 5z'/%3E%3C/svg%3E");
		}

		button {
			border-radius: 5px;
			border: none;
			padding: 7px 15px;
			background: #2e363d;
			color: white;
			font-family: 'Poppins';
			font-size: 11px;
			cursor: pointer;
		}

		input[type="file"]::after {
			position: absolute;
			pointer-events: none;
			top: 11px;
			left: 40px;
			color: white;
			content: "Upload File";
		}

		/* file upload button */
		input[type="file"]::file-selector-button {
			border-radius: 4px;
			padding: 0 16px;
			height: 40px;
			cursor: pointer;
			border-radius: 5px;
			background-color: #2f2f2f;
			border: 1px solid rgba(0, 0, 0, 0.16);
			box-shadow: 0px 1px 0px rgba(0, 0, 0, 0.05);
			margin-right: 16px;
			transition: background-color 200ms;
		}

		/* file upload button hover state */
		input[type="file"]::file-selector-button:hover {
			background-color: #3f3f3f;
		}

		/* file upload button active state */
		input[type="file"]::file-selector-button:active {
			background-color: grey;
		}

		dialog::backdrop {
			backdrop-filter: blur(13px);
		}

		#upmod {
			border: 1px solid grey;
			background: #1f1f1f;
			color: white;
			border-radius: 10px;
			padding: 25px;
			animation: pop .2s;
			text-align: center;
		}

		#upmod [cv] {
			display: block;
			padding: 5px 10px;
			background: #282828;
			width: fit-content;
			border-radius: 10px;
			opacity: 0.5;
			font-size: 11px;
			margin: 5px auto;
			margin-bottom: 10px;
		}

		@keyframes pop {
			0% {
				opacity: 0;
				transform: translate(10px, -10px) scale(0.9);
			}

			100% {
				transform: none;
				opacity: 1;
			}
		}

		#upmod svg {
			height: 69px;
			margin-bottom: 13px;
		}

		.custom-loader {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: #92D8F4;
			clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
			animation: sh1 2s infinite cubic-bezier(0.3, 1, 0, 1);
		}

		@keyframes sh1 {
			33% {
				border-radius: 0;
				background: #ED8850;
				clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%)
			}

			66% {
				border-radius: 0;
				background: #89CB91;
				clip-path: polygon(50% 0, 50% 0, 100% 100%, 0 100%)
			}
		}

		/* Dropup Button */
		.dropbtn {
			background-color: #2d2d2d;
			color: white;
			padding: 2px 10px;
			margin-right: 10px;
			font-size: 11px;
			border: none;
		}

		.dropbtn {
			background-color: #2d2d2d;
			color: white;
			padding: 2px 10px;
			margin-right: 10px;
			font-size: 11px;
			border: none;
		}

		.notdropbtn {
			background-color: #2d2d2d;
			color: white;
			font-size: 11px;
			border: none;
			padding: 5px;
			transform: translate(-5px, 2px);
		}

		.notdropbtn span {
			font-size: 11px !important;
		}

		/* The container <div> - needed to position the dropup content */
		.dropup {
			position: relative;
			display: inline-block;
		}

		@keyframes bop {
			0% {
				transform: scaleY(0.5) translateY(35px);
				opacity: 0%;
			}

			100% {
				opacity: 100%;
			}
		}

		/* Dropup content (Hidden by Default) */
		.dropup-content {
			display: none;
			position: absolute;
			animation: bop 0.2s;
			bottom: 21px;
			border-bottom: 5px solid #161616;
			border-radius: 5px;
			background-color: #282828;
			min-width: 160px;
			z-index: 1;
			overflow: hidden;
		}

		/* Links inside the dropup */
		.dropup-content a {
			color: white;
			padding: 3px 6px;
			text-decoration: none;
			display: block;
			cursor: pointer;
		}

		.dropup-content a span {
			font-size: 10px;
			transform: scale(1.5);
			margin-right: 5px;
			padding: 1px;
			background: #3d3d3d;
			border-radius: 2px;
			color: #eaeaea;
		}

		/* Change color of dropup links on hover */
		.dropup-content a:hover {
			color: #cbcbcb;
			background: #1f1f1f;
		}

		/* Show the dropup menu on hover */
		.dropup:hover .dropup-content {
			display: block;
		}

		/* Change the background color of the dropup button when the dropup content is shown */
		.dropup:hover .dropbtn {
			background-color: #393939;
		}

		[flap-fl-topnav] div {
			display: inline-block;
			transform: translate(-5px, -2px);
		}

		.flarrbtn {
			padding: 1px 2px;
			height: 15px;
		}

		.nvbtns {
			float: right;
		}

		.nvbtns span {
			font-size: 13px;
		}

		.newfilebtn {
			position: absolute;
			bottom: 55px;
			right: 15px;
			padding: 0.5em;
			border-radius: 1em;
			height: 37px;
		}

		.newfilebtn:hover {
			background-color: #465969;
		}

		.newfoldbtn {
			float: right;
			margin: 0px;
			font-size: 13px;
			cursor: pointer;
			background: #333333;
			display: grid;
			align-items: center;
			justify-items: center;
			justify-content: center;
			align-content: center;
			border-radius: 0.2rem;
			height: 9px;
			width: 6px;
			text-align: right;
			padding: 4px;
		}

		.drivenav {
			background: #3939395e;
			padding: 3px;
			border-radius: 0.3rem;
			margin: 2px;
			cursor: pointer;
		}

		.im {
			font-size: 10px !important;
			margin-right: 5px;
			transform: scale(1.2) translate(1px, 1px);
		}

		[flap-files] svg {
			margin-bottom: 1rem;
			height: 50px;
		}

		#jstree {
			margin-top: 0.5rem;
			transform: translateX(-5px);
			display: inline-block;
			width: fit-content;
		}

		.jstree-default .jstree-icon:empty {
			color: #897b31;
		}

		.jstree-default .jstree-node {
			margin-left: 10px !important;
			margin-bottom: 0.1rem;
		}

		.jstree-anchor {
			padding: 0 6px 0 3px;
			border-radius: 0.3rem !important;
		}

		.jstree-default .jstree-icon:empty {
			width: 17px !important;
		}

		.jstree-icon.jstree-themeicon {
			display: none;
		}

		.jstree-ocl {
			display: inline-block;
			font-family: 'FontAwesome';
			font-style: normal;
			font-weight: normal;
			font-size: 8px;
			width: 1em;
			height: 1em;
			line-height: 1em;
			text-align: center;
		}

		#pathdisp {
			flex: 1;
			overflow-x: hidden;
			text-overflow: ellipsis;
			margin: 0 0.5rem;
			display: flex;
			user-select: text;
			-moz-user-select: text;
		}

		#pathdisp span {
			display: inline-block;
			opacity: 0.7;
		}

		#pathdisp span:hover {
			opacity: 1;
		}

		.thisfolderisempty {
			padding-top: 3rem;
    opacity: 0.5;
    scale: 0.7;
		}
	</style>
	<script src="https://unpkg.com/interactjs/dist/interact.min.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css">
	<script src="https://kit.fontawesome.com/3ea8b9584f.js" crossorigin="anonymous"></script>

	<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">

	<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
</head>

<body>
	<dialog id="ld">
		<div class="custom-loader"></div>
	</dialog>
	<dialog id="upmod">
		<div>
			<svg style="height: 50px;" version="1.1" xmlns="http://www.w3.org/2000/svg"
				xmlns:xlink="http://www.w3.org/1999/xlink" width="209.43806" height="162.25"
				viewBox="0,0,209.43806,162.25">
				<g transform="translate(-140.68755,-116.25)">
					<g data-paper-data="{&quot;isPaintingLayer&quot;:true}" fill-rule="nonzero" stroke-linejoin="miter"
						stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" style="mix-blend-mode: normal">
						<path
							d="M159.5,198c0,-44.45892 36.04108,-80.5 80.5,-80.5c44.45893,0 80.5,36.04108 80.5,80.5c0,44.45892 -36.04107,80.5 -80.5,80.5c-44.45892,0 -80.5,-36.04108 -80.5,-80.5z"
							fill-opacity="0.20784" fill="#66bfff" stroke="none" stroke-width="0"
							stroke-linecap="butt" />
						<g fill="none" stroke="none" stroke-width="1" stroke-linecap="butt" font-family="sans-serif"
							font-weight="normal" font-size="12" text-anchor="start" />
						<g fill="#b5e0ff" stroke="none" stroke-width="0" stroke-linecap="butt">
							<path
								d="M283.87771,241.79302c-4.02173,-8.33081 -0.52853,-18.34453 7.80228,-22.36626c8.33081,-4.02173 18.34453,-0.52853 22.36626,7.80228c4.02173,8.33081 0.52853,18.34453 -7.80228,22.36625c-8.33081,4.02173 -18.34453,0.52853 -22.36626,-7.80228z" />
							<path
								d="M273.25718,259.24412c-4.98215,-10.32026 -0.65475,-22.72531 9.66551,-27.70745c10.32026,-4.98215 22.72531,-0.65475 27.70745,9.66551c4.98215,10.32026 0.65475,22.7253 -9.66551,27.70745c-10.32026,4.98215 -22.72531,0.65475 -27.70745,-9.66551z" />
							<path
								d="M321.85231,245.54072c-3.57143,-7.39803 -0.46935,-16.29055 6.92869,-19.86197c7.39803,-3.57143 16.29054,-0.46935 19.86197,6.92868c3.57143,7.39803 0.46935,16.29055 -6.92868,19.86198c-7.39803,3.57143 -16.29055,0.46935 -19.86198,-6.92869z" />
							<path
								d="M303.83054,248.09589c-3.57143,-7.39803 -0.46936,-16.29055 6.92868,-19.86198c7.39803,-3.57143 16.29055,-0.46935 19.86198,6.92869c3.57143,7.39803 0.46935,16.29055 -6.92868,19.86198c-7.39803,3.57143 -16.29055,0.46936 -19.86198,-6.92868z" />
							<path
								d="M306.87771,258.29302c-4.02173,-8.33081 -0.52853,-18.34453 7.80228,-22.36626c8.33081,-4.02173 18.34453,-0.52853 22.36626,7.80228c4.02173,8.33081 0.52853,18.34453 -7.80228,22.36625c-8.33081,4.02173 -18.34453,0.52853 -22.36626,-7.80228z" />
						</g>
						<g fill="#b5e0ff" stroke="none" stroke-width="0" stroke-linecap="butt">
							<path
								d="M140.68756,140c0,-9.25077 7.49923,-16.75 16.75,-16.75c9.25077,0 16.75,7.49923 16.75,16.75c0,9.25077 -7.49923,16.75 -16.75,16.75c-9.25077,0 -16.75,-7.49923 -16.75,-16.75z" />
							<path
								d="M184.063,149c0,-8.21499 6.65957,-14.87455 14.87456,-14.87455c8.21499,0 14.87455,6.65956 14.87455,14.87455c0,8.21499 -6.65956,14.87455 -14.87455,14.87455c-8.21499,0 -14.87456,-6.65956 -14.87456,-14.87455z" />
							<path
								d="M162.313,148c0,-8.21499 6.65957,-14.87455 14.87456,-14.87455c8.21499,0 14.87455,6.65956 14.87455,14.87455c0,8.21499 -6.65956,14.87455 -14.87455,14.87455c-8.21499,0 -14.87456,-6.65956 -14.87456,-14.87455z" />
							<path
								d="M156.43756,137c0,-11.45991 9.29009,-20.75 20.75,-20.75c11.45991,0 20.75,9.29009 20.75,20.75c0,11.45991 -9.29009,20.75 -20.75,20.75c-11.45991,0 -20.75,-9.29009 -20.75,-20.75z" />
						</g>
						<g fill="none" stroke="#56b8ff" stroke-width="10" stroke-linecap="round">
							<path d="M239.21771,168.1191v74.73533" />
							<path d="M211.45887,188.04852l27.40295,-27.40295l28.82648,28.82648" />
						</g>
					</g>
				</g>
			</svg><br>
			<span style="display: block;
			opacity: 0.7;
			margin-bottom: 13px;
		">Import your files</span>
			<small cv><span class="material-symbols-rounded im">lock</span>Files won't leave your device.</small>
			<input type="file" id="filupin" multiple/><br>
			<button onclick="fupit()" id="fupibu">
				Import These
			</button>
		</div>
		<script>
			const dbChangeEvent = new Event('dbchange');

function triggerDBChange() {
  document.dispatchEvent(dbChangeEvent);
}

async function fupit() {
  document.getElementById("fupibu").innerHTML = "Importing...";
  const fileInput = document.getElementById('filupin');
  const files = fileInput.files;

  if (files.length === 0) return;

  const workerCode = `
    onmessage = function(event) {
      const file = event.data.file;
      const chunkSize = event.data.chunkSize;
      const delay = event.data.delay;
      const fileReader = new FileReader();
      let offset = 0;

      function readNextChunk() {
        const chunk = file.slice(offset, offset + chunkSize);
        fileReader.readAsArrayBuffer(chunk);
      }

      fileReader.onload = async function(e) {
        postMessage({ chunk: e.target.result, offset: offset });

        offset += chunkSize;
        if (offset < file.size) {
          setTimeout(readNextChunk, delay); // Delay between chunks
        } else {
          postMessage({ done: true });
        }
      };

      readNextChunk();
    };
  `;

  const workerBlob = new Blob([workerCode], { type: 'application/javascript' });

  async function processFile(file, chunkSize, delay) {
    return new Promise((resolve) => {
        const worker = new Worker(URL.createObjectURL(workerBlob));
        const combinedChunks = [];

        worker.onmessage = async function(event) {
            if (event.data.done) {
                const combined = new Blob(combinedChunks, { type: file.type });
                const reader = new FileReader();

                reader.onload = async function(e) {
                    let content = e.target.result;
                    const type = file.type || 'txt';
                    const folderName = 'Downloads/';
                    const metadata = { "via": "imported" };

                    // Convert raw text to base64 if content is not in a specific format
                    const isFormatSpecific = content.startsWith("data:");
                    if (!isFormatSpecific) {
                        content = btoa(content);
                    }

                    await window.parent.createFile(folderName, window.parent.basename(file.name), mtpetxt(type), content, metadata);

                    resolve();
                };

                reader.readAsDataURL(combined);
            } else {
                combinedChunks.push(event.data.chunk);
            }
        };

        worker.postMessage({ file, chunkSize, delay });
    });
}
  const chunkSize = 1024 * 1024; // 1MB chunks
  const delay = 100; // 100ms delay between chunks

  for (let i = 0; i < files.length; i++) {
    await processFile(files[i], chunkSize, delay);
  }

  document.getElementById("fupibu").innerHTML = "File(s) Saved, Close";
  document.getElementById("fupibu").onclick = function() {
    document.getElementById("upmod").close();
  };
}

			function getBase64(file) {
				var reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = function () {
					out = reader.result;
					document.getElementById("fupibu").innerHTML = "Saving..."
				};
				reader.onerror = function (error) {
					console.log('Error: ', error);
				};
			}

			function b64EncodeUnicode(str) {
				return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
			}

			async function makefolderhuh() {
				let x = await window.parent.ask("Enter your Folder Name:", currentPath);
				window.parent.createFolder(x);
			}
		</script>
	</dialog>

	<div id="flap-mot">
		<div flap-nav>
			<div class="nowid">
				<span class="material-symbols-rounded navbfobtns" onclick="refresh()">
					refresh
				</span>
			</div>
			<div class="nowid flappsearch" id="fileapptitledis">
				Files App 2.2
			</div>
			<div class="nowid"><span class="material-symbols-rounded navbfobtns" onclick="upmd()">upload</span></div>
		</div>
		<div style="height: calc(100% - 48px);">
			<div class="themainstuff">
				<div flap-sidenav id="flap-sidenav">
					<div class="drivenav">
						<small onclick="listFiles('')">IndexedDB</small>
						<small class="newfoldbtn" onclick="makefolderhuh()">+</small>
					</div>
					<div id="folders">

					</div>
					<div id="jstree"></div>
					<div flap-sidenav-mems>

					</div>
				</div>
				<div flap-mains style="flex-grow: 3;
		display: flex;
		flex-direction: column;
		height: 100%;width: 0;">
					<div flap-fl-topnav><span id="pathdisp">
							/
						</span>

						<div class="nvbtns">
							<button class="flarrbtn" title="Sorting">
								<span class="material-symbols-rounded">
									sort
								</span>
							</button>
							<button class="flarrbtn" onclick="changeview('list')" title="Change View to List">
								<span class="material-symbols-rounded">
									view_list
								</span>
							</button>
							<button class="flarrbtn" onclick="changeview('grid')" title="Change View to Grid">
								<span class="material-symbols-rounded">
									grid_view
								</span>
							</button>
							<button class="flarrbtn" onclick="remfold()" id="remfoldbtn" title="Remove Folder"
								style="background-color: #7f4040;">
								<span class="material-symbols-rounded">
									delete_forever
								</span>
							</button>
						</div>
					</div>
					<div flap-files id="filelist">

					</div>
					<div flap-fl-bottomnav id="fileinfobn">Click on a file to select it.
					</div>
					<button class="newfilebtn"
						onclick="document.getElementById('makefiledia').showModal(); document.getElementById('makflatw').value = currentPath">
						<span class="material-symbols-rounded">
							add
						</span>
					</button>
				</div>
			</div>
		</div>
	</div>

	<style>
		inpg {
			display: block;
			max-width: calc(100% - 30px);
			width: 300px;
			margin: auto;
		}

		#makefiledia {
			max-width: 80%;
			min-height: 50px;
			max-height: 80vh;
			min-width: 300px;
			padding: 1rem 0rem;
			padding-top: 0.7rem;
			border: none;
			background: #1c1c1c;
			color: white;
			border-radius: 0.5rem;
			box-shadow: 0 0 10px #00000057;
		}

		#makefiledia input,
		#makefiledia textarea {
			display: block;
			width: calc(100% - 20px);
			background: #101010;
			color: white;
			padding: 7px 10px;
			border: 1px solid #2f2f2f;
			border-radius: 5px;
			outline: none;
			resize: none;
		}

		#makefiledia label {
			text-transform: capitalize;
			font-size: 14px;
			font-weight: normal;
			opacity: 0.8;
			margin-bottom: 0.3rem;
			display: block;
		}

		.makefilediv {
			height: 100%;
		}

		.makefilediv h1 {
			text-align: center;
			margin-bottom: 4px;
		}

		.makefilediv p {
			font-size: 14px;
			text-align: center;
			opacity: 0.5;
			margin: auto;
			width: 70%;
		}

		.makefilediv .btncont {
			display: flex;
			width: calc(100% - 2rem);
			flex-direction: row;
			margin: 0 1rem;
			gap: 0.5rem;
		}

		.makefilediv button {
			flex: 1;
			margin: auto;
			display: block;
			margin-top: 10px;
			background: #4d7297;
		}

		.makefilediv button.cancel {
			flex: 1;
			margin: auto;
			display: block;
			margin-top: 10px;
			background: #272727;
		}

		#makefiledivno {
			color: #ff6161;
			opacity: 1;
			font-size: 0.8rem;
			line-height: 1.2rem;
			display: block;
			margin: 0.5rem 0rem;
		}

		#makefiledivno .material-symbols-rounded {
			font-size: 10px;
			transform: translate(4px, 1px) scale(1.5);
			margin-right: 7px;
		}

		.jstree-default .jstree-clicked {
			background: #2c2c2c;
			box-shadow: none;
		}

		.jstree-default .jstree-hovered {
			background: #272727;
			box-shadow: none;
		}

		.loader33 {
	width: 5px;
    height: 3px;
    border-radius: 1rem;
    display: block;
    margin: 15px auto;
    position: relative;
    color: #ffffff;
    left: -100px;
    box-sizing: border-box;
    animation: shadowRolling 2s linear infinite;
	opacity: 0.5;
  }
  
  @keyframes shadowRolling {
	0% {
	  box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
	}
	12% {
	  box-shadow: 100px 0 white, 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
	}
	25% {
	  box-shadow: 110px 0 white, 100px 0 white, 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
	}
	36% {
	  box-shadow: 120px 0 white, 110px 0 white, 100px 0 white, 0px 0 rgba(255, 255, 255, 0);
	}
	50% {
	  box-shadow: 130px 0 white, 120px 0 white, 110px 0 white, 100px 0 white;
	}
	62% {
	  box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 white, 120px 0 white, 110px 0 white;
	}
	75% {
	  box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 white, 120px 0 white;
	}
	87% {
	  box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 white;
	}
	100% {
	  box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
	}
  }
	</style>
	<dialog id="makefiledia">
		<div class="makefilediv">
			<inpg>
				<label>New File: </label>
				<input id="makflname" value="" placeholder="File Name">
				<span id="makefiledivno"></span>
			</inpg>
			<div class="btncont">
				<button onclick="document.getElementById('makefiledia').close()" class="cancel">Cancel</button>
				<button onclick="createit()">Create</button>
			</div>
		</div>
	</dialog>
	<script>
		async function createit() {
			let fname = document.getElementById("makflname").value;

			if (fname.length < 2 || window.parent.mtpetxt(fname) == "" || !window.parent.mtpetxt(fname)) {
				document.getElementById("makefiledivno").innerHTML = `<span class="material-symbols-rounded">
									error
								</span> File names should end with extensions (eg: .txt, .png etc.)`
				return;
			}

			await window.parent.createFile(currentPath, window.parent.basename(fname), window.parent.mtpetxt(fname))
				.then(function () {
					document.getElementById('makefiledia').close();
					window.parent.notify("Created file", "File " + fname + " created at " + currentPath, "Files");
				});
		}

		var dropZone = document.getElementById("flap-mot");
		dropZone.addEventListener('dragover', (event) => {
			event.preventDefault();
		});

		dropZone.addEventListener('drop', (event) => {
			event.preventDefault();

			const files = event.dataTransfer.files;

			for (let i = 0; i < files.length; i++) {
				const file = files[i];
				const reader = new FileReader();

				reader.onload = (e) => {
					const fileContent = e.target.result;
					if (file.type.startsWith('video') || file.type.startsWith('audio') || file.type.startsWith('image')) {
						folderName = 'Media';

						out = window.parent.shrinkbsf(fileContent)

					} else if (file.type.startsWith('text') || file.type.endsWith('md') || file.type.endsWith('rtf')) {
						folderName = 'Documents';
					} else if (file.type.startsWith('html')) {
						folderName = 'Apps';
					} else {
						folderName = 'Other';
					}

					let md = {
						"via": "imported"
					}
					window.parent.createFile(folderName, file.name, file.type, out, md).then(() => {
						listFiles(folderName, true)
					});
				};

				reader.readAsText(file);
			}
		});


		dropZone.addEventListener('dragend', (event) => {
			event.preventDefault();
		});

		var currentPath = '', nowfile, flmode = 'grid';
		var memory;
		var fllist;
		var fdlist;
		var binmode = false;
		var sessiontype = "normal"

		function fitsizesidenav() {
			document.getElementById("flap-sidenav").style.width = getComputedStyle(document.getElementById("jstree")).width
		}
		function greenflagbro() {
			if (window.parent.getSetting("filesSidenavSize")) {
				document.getElementById("flap-sidenav").style.width = window.parent.getSetting("filesSidenavSize");
			} else {
				fitsizesidenav();
			}

			$("#flap-sidenav").resizable({
				handles: 'e',
				stop: function (event, ui) {
					const newWidth = ui.size.width;
					window.parent.setSetting("filesSidenavSize", newWidth + 'px');
				}
			});

			$('button').on('click', function () {
				$('#jstree').jstree(true).select_node('child_node_1');
				$('#jstree').jstree('select_node', 'child_node_1');
				$.jstree.reference('#jstree').select_node('child_node_1');
			});

			var todo = localStorage.getItem("todo");

			var defile
			try {
				let parsedTodo = JSON.parse(todo);

				if (parsedTodo.appname === "files" && parsedTodo.data.type == "open") {
					sessiontype = "opener";
					document.getElementById("fileapptitledis").innerText = "Open File"
					localStorage.setItem("todo", "");
				}
			} catch (error) {
				console.log(error)
			}
			fllist = document.getElementById("filelist");
			fdlist = document.getElementById("folders");

			try {
				if (localStorage.getItem('qsets')) {
					if (JSON.parse(localStorage.getItem('qsets')).defFileLayout) {
						changeview(JSON.parse(localStorage.getItem('qsets')).defFileLayout)
					}
				}
			} catch (error) {
				console.error(error)
			}

			window.parent.getdb('trojencat', 'rom')
				.then((result) => {
					try {
						if (result !== null) {
							memory = result;
							refresh()

						} else {
							console.log('0003');
						}
					} catch (error) {
						console.error('Error:', error);
					}
				})
				.catch((error) => {
					console.error('Database operation failed:', error);
				});
			const backdrop = document.getElementById('upmod');

			backdrop.addEventListener('click', (event) => {
				if (event.target === backdrop) {
					backdrop.close();
				}
			});

		}

		function Allowdrop(ev, obj) {
			console.log("allowdrop")
			ev.preventDefault();
			obj.style.transform = "scale(1.1)";
			setTimeout(function () {
				obj.style.transform = "";
			}, 500)
		}

		function dropfl(ev, dat) {
			let data = ev.dataTransfer.getData("Text");
			console.log("moving " + data + " to " + dat)
			moveFileToFolder(data, dat)
		}

		function memoryToJsTree(memory, parentPath = '') {
			function traverse(obj, parentPath) {
				let result = [];

				for (let key in obj) {
					if (obj.hasOwnProperty(key) && key.endsWith('/')) { // Only process folders
						let currentPath = parentPath ? `${parentPath}${key}` : key;

						let node = {
							text: key,
							icon: getfolicon(key),
							state: {
								opened: false,
								selected: false,
								disabled: false
							},
							li_attr: {
								'data-path': currentPath
							}
						};

						node.children = traverse(obj[key], currentPath);
						result.push(node);
					}
				}

				return result;
			}

			return traverse(memory, parentPath);
		}

		function liststuff() {
			$(function () {
				// Convert memory to jsTree data
				const jsTreeData = memoryToJsTree(memory);

				if ($('#jstree').jstree(true)) {
					$('#jstree').jstree('destroy').empty();
				}

				$('#jstree').jstree({
					'core': {
						'data': jsTreeData
					}
				}).on('loaded.jstree', function () {
					addDragAndDropListeners();
				});

				$('#jstree').on("changed.jstree", function (e, data) {
					if (data?.node?.li_attr?.['data-path']) {
						let selectedPath = data.node.li_attr['data-path'];
						console.log('Selected folder:', selectedPath);
						listFiles(selectedPath);

						if (!window.parent.getSetting("filesSidenavSize")) {
							fitsizesidenav();
						}
					} else {
						console.log('No folder selected');
					}
				});
			});
		}
		async function refresh() {
				console.log("refresh called")
			setTimeout(() => {
				window.parent.getdb('trojencat', 'rom')
					.then((result) => {
						if (result !== null) {
							memory = result;
						}
					});
				liststuff();
				listFiles(currentPath);
			}, 1000);
		}

		function addDragAndDropListeners() {
			console.log("trying to add event listeners")
			document.querySelectorAll('#jstree li[role="none"]').forEach(function (element) {
				const folderName = element.querySelector('a').textContent;
				console.log(element)
				element.addEventListener('dragover', function (event) {
					Allowdrop(event, element);
				});

				element.addEventListener('drop', function (event) {
					dropfl(event, folderName);
				});
			});
		}

		function dragfl(ev, obj) {
			ev.dataTransfer.setData("Text", obj.getAttribute('unid'));
		}

		async function listFiles(folderName, gen) {
			console.log(folderName)
			const startTime = performance.now();
			if (currentPath == folderName && gen) {
				return;
			}
			if (folderName == "System/") {
				document.getElementById("remfoldbtn").style.display = "none";
			} else {
				document.getElementById("remfoldbtn").style.display = "";
			}
			fllist.innerHTML = `<div class="loader33" id='listfilesloader'></div>`

			function findFolder(path, obj) {
				let parts = path.split('/').map((part, index, array) => {
					if (part === '' && array[index + 1] === '') {
						return '/';
					}
					if (part !== '' && index < array.length - 1 && array[index + 1] === '') {
						return part + '/';
					}
					return part;
				});


				for (let part of parts) {
					if (part) {
						if (obj[part + '/']) {
							obj = obj[part + '/'];
						} else if (obj[part]) {
							obj = obj[part];
						} else {
							return null;
						}
					}
				}

				return obj;
			}

			// Find the folder with the given name
			const folder = findFolder(folderName, memory);
			if (folder) {
				currentPath = folderName;
				updpth();

				// Display files and subfolders in the folder
				const content = Object.keys(folder).map(key => ({
					name: key,
					...folder[key],
					type: key.endsWith('/') ? 'folder' : 'file'
				}));

				if (content.length > 0) {
					// Sort files by file name
					content.sort((a, b) => a.name.localeCompare(b.name));

					for (let item of content) {
						try {
							fileData = await window.parent.getFileById(item.id);
							let fileElement = document.createElement('div');
							fileElement.classList.add("file");
							fileElement.setAttribute(flmode, '');
							fileElement.setAttribute("unid", item.id || '');
							fileElement.setAttribute("draggable", !item.name.endsWith('/'));

							fileElement.setAttribute("onclick", "slfile(this, '"+item.id+"');");
							if (!item.name.endsWith('/')) {
								fileElement.setAttribute("ondragstart", "dragfl(event, this)");
							}
							let icon = item.type === 'folder' ? geticon('folder') : geticon(ptypext(item.name));
							if (window.parent.getbaseflty(ptypext(item.name)) == "music" && false) {
								jsmediatags.read(window.parent.unshrinkbsf(fileData.content), {
									onSuccess: function (tag) {
										icon = tag;
									},
									onError: function (error) {
										console.error('Error reading metadata:', error);
									}
								});
							}

							fileElement.innerHTML = `<span class="fileicons">${icon}</span><span flname><span class='flfrname'> ${item.name}</span> <small>${item.id || '>'}</small></span>`;
							fileElement.setAttribute("title", `${item.name}\nID: ${item.id || 'Folder'}`);
							fllist.appendChild(fileElement);
						} catch (error) {
							console.error("Safe Error processing item:", error);
							console.log("This item caused error: " + item.name);
							// error files
							let fileElement = document.createElement('div');
							fileElement.classList.add("file");
							fileElement.setAttribute(flmode, '');
							fileElement.setAttribute("unid", item.id || '');
							fileElement.setAttribute("onclick", "slfile(this, '"+item.id+"')");

							// Assuming metadata is stored as a JSON object within the file
							let metadata = {};
							if (item.metadata) {
								try {
									metadata = JSON.parse(item.metadata);
								} catch (error) {
									console.error("Safe Error parsing metadata:", error);
								}
							}

							const icon = item.type === 'folder' ? geticon('folder') : geticon(ptypext(item.name));
							fileElement.innerHTML = `<span>${icon}</span><span flname><span class='flfrname'> ${item.name}</span> <small>${ptypext(item.name)}</small></span>`;
							fllist.appendChild(fileElement);
						}
					}
					const endTime = performance.now(); // End the timer if the file is not found
					const timeTaken = endTime - startTime;
					document.getElementById("fileinfobn").style.opacity = 0.5;
					document.getElementById("fileinfobn").innerHTML = `Listed ${content.length} item(s) in ` + timeTaken.toFixed(2) + "ms";
				} else {
					fllist.innerHTML = `<center class='thisfolderisempty'><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="74.20199" height="94.1023" viewBox="0,0,74.20199,94.1023"><g transform="translate(-224.61774,-142.87893)"><g data-paper-data="{&quot;isPaintingLayer&quot;:true}" fill-rule="nonzero" stroke="#ffffff" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" style="mix-blend-mode: normal"><path d="M227.11774,158.26119c0,-7.11468 5.76758,-12.88226 12.88226,-12.88226c7.11468,0 12.88226,5.76758 12.88226,12.88226c0,7.11468 -5.76758,12.88226 -12.88226,12.88226c-7.11468,0 -12.88226,-5.76758 -12.88226,-12.88226z" fill="none" stroke-width="5" stroke-linecap="butt"/><path d="M244.56247,233.94447l9.12493,-32.20565l-8.58817,-28.98508" fill="none" stroke-width="5" stroke-linecap="round"/><path d="M253.6874,202.81234l17.71311,31.66888" fill="none" stroke-width="5" stroke-linecap="round"/><path d="M246.17275,178.6581l-7.51465,27.37481" fill="none" stroke-width="5" stroke-linecap="round"/><path d="M250.46684,179.73163l28.44833,-12.3455" fill="none" stroke-width="5" stroke-linecap="round"/><path d="M260.82196,192.96703l-1.81137,-23.54791l37.99776,-2.9229l1.81138,23.54791z" fill="#aa8b00" stroke-width="0" stroke-linecap="butt"/><path d="M256.80524,189.29958l2.20535,-19.88046l37.99776,-2.9229l-2.20535,19.53118z" fill="#ffcf00" stroke-width="0" stroke-linecap="butt"/><path d="M279.06646,168.81576l-0.1513,-1.42964" fill="none" stroke-width="5" stroke-linecap="round"/></g></g></svg><br>This folder is empty.</center>`;
				}
				try {
				document.getElementById("listfilesloader").remove()
				}catch {}
			} else {
				console.log("0003 b: no folder.");
			}


		}

		function updpth() {
			const pathDisp = document.getElementById("pathdisp");
			pathDisp.innerHTML = "";

			const parts = currentPath.split('/').filter(Boolean);
			let accumulatedPath = "";

			parts.forEach((part, index) => {
				const currentPart = part + "/";
				accumulatedPath += currentPart;

				const span = document.createElement("span");
				span.textContent = currentPart;

				if (index < parts.length - 1) {
					// Create a closure to capture the current value of accumulatedPath
					const pathToCall = accumulatedPath;
					span.style.cursor = "pointer";
					span.addEventListener("click", () => listFiles(pathToCall));
				}

				pathDisp.appendChild(span);
			});
		}

		async function slfile(y, z) {
			let x = y;
			if (x.id === "slfile") {
				if (x.getAttribute("unid") === null || x.getAttribute("unid") === "") {
					let folderPath = x.querySelector(".flfrname").innerText.trim();
					listFiles(currentPath + folderPath)
					return;
				}
				openfile(z);
			} else {

				if (document.getElementById("slfile")) { document.getElementById("slfile").id = null; }
				nowfile = x;

				var fileSize
				x.id = "slfile";
				let fileData
				if (!(x.getAttribute("unid") === null || x.getAttribute("unid") === "")) {
					if (sessiontype == "opener") {
						return;
					}
					try {
						console.log(x.getAttribute("unid"))
						fileData = await window.parent.getFileById(x.getAttribute("unid"));

						if (fileData && fileData.content) {
							fileSize = new TextEncoder().encode(fileData.content).length;
						} else {
							console.error("Safe Error: Unable to retrieve file content.");

						}
					} catch (error) {
						console.error("Safe Error:", error);
					}

					if (fileSize !== 0) {
						try {
							var units = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
							var unitIndex = 0;

							while (fileSize > 1024 && unitIndex < units.length - 1) {
								fileSize /= 1024;
								unitIndex++;
							}

							fileSize = fileSize.toFixed(2);
						} catch (error) {
							console.error(error)
							fileSize = 0
						}
					}

					document.getElementById("fileinfobn").style.opacity = 1;

					if (binmode) {
						document.getElementById("fileinfobn").innerHTML = `<button class="delbtn" onclick="remfile('` + x.getAttribute("unid") + `')">Delete</button>`;
					} else {
						document.getElementById("fileinfobn").innerHTML = `<button class="delbtn" onclick="remfile('` + x.getAttribute("unid") + `')"><span class="material-symbols-rounded">
delete
</span> Delete</button>`;
					}
					try {
						document.getElementById("fileinfobn").innerHTML += `<div class="dropup">
								  <button class="dropbtn">More</button>
								  <div class="dropup-content">
									${window.parent.getbaseflty(mtpetxt(fileData.fileName)) == "image" ? '<a onclick="window.parent.makewall(\'' + x.getAttribute("unid") + '\')"><span class="material-symbols-rounded">wallpaper</span> Set As Wallpaper</a>' : ''}
									${window.parent.getbaseflty(mtpetxt(fileData.fileName)) == "app" || window.parent.getbaseflty(mtpetxt(fileData.fileName)) == "osl" || window.parent.getbaseflty(mtpetxt(fileData.fileName)) == "wasm" ? `<a onclick="openfile(document.getElementById('` + x.id + `'), 'text/html')"><span class="material-symbols-rounded">
									construction
									</span> Open in studio</a>` : ''}
									
									<a onclick="openfile('`+ x.getAttribute("unid") + `', 'any')"><span class="material-symbols-rounded">
open_in_new
</span> Open as text</a>
									<a onclick="renamef(document.getElementById('`+ x.id + `'))"><span class="material-symbols-rounded">
save_as
</span> Rename</a>
									<a onclick="movefile(document.getElementById('`+ x.id + `'))"><span class="material-symbols-rounded">
drive_file_move
</span> Move</a>
								  </div>
								</div> `+ fileSize + ' ' + units[unitIndex]

					} catch (error) {
						document.getElementById("fileinfobn").innerHTML += "Safe Error 0006";
						window.parent.say(`<h1>File Error</h1><p>Nova files couldn't process that file</p><small>(Error 0006)</small>`, "warning")
						refresh()
						console.error("An error occurred:", error);

					}

				} else {

					document.getElementById("fileinfobn").innerHTML = x.querySelector(".flfrname").innerText.trim();
				}
			}
		}

		async function remfile(ID) {
			try {

				window.parent.remfile(ID);
				console.log(`0004`);

				document.getElementById("fileinfobn").style.opacity = 1;
				document.getElementById("fileinfobn").innerHTML = "Deleting file...";
				await window.parent.updateMemoryData().then(() => {
					document.getElementById("fileinfobn").innerHTML = "File Deleted";
				});
				document.querySelector(`[unid="${ID}"]`).style.opacity = 0.2;
			} catch (error) {
				console.error("Safe Error fetching or updating data:", error);
			}
		}

		async function openfile(...args) {
    console.log("filesapp default openfile: ", args[0]);
    if (sessiontype == "opener") {
        localStorage.setItem("todo", JSON.stringify({ "type": "opentotext", "lclfile": args[0].getAttribute("unid") }));
        window.parent.clwin(myWindow);
        return;
    }

    window.parent.openfile(...args);
}

		async function renamef(x) {
			document.getElementById("fileinfobn").style.opacity = 1;
			try {
				const fileId = x.getAttribute("unid");

				let file = await window.parent.getFileById(fileId);

				file.fileName = await window.parent.ask("New Name:", file.fileName);
				await window.parent.updateFile(currentPath, fileId, file);

				document.getElementById("fileinfobn").innerHTML = "File renamed successfully.";

			} catch (error) {
				console.error("Safe Error renaming file:", error);
				document.getElementById("fileinfobn").innerHTML = "Failed to rename file.";
			}
		}

		async function moveFileToFolder(flid, dest) {
			console.log("Moving file with id: " + flid + " to folder: " + dest);

			let fileToMove = await window.parent.getFileById(flid);

			await window.parent.createFile(dest, fileToMove.fileName, fileToMove.type, fileToMove.content, fileToMove.metadata);
			console.log("File created in folder: " + dest);

			console.log("Removing file: " + flid);
			await remfile(flid);

			document.getElementById("fileinfobn").style.opacity = 1;
			document.getElementById("fileinfobn").innerHTML = "File was moved to " + dest;
		}


		async function movefile(flid) {
			// Get file ID from the attribute
			flid = flid.getAttribute("unid");
			console.log("NAV MOVE file with id: " + flid);

			// Function to get folder names from the memory object
			const getFolderNames = (memory) => {
				return Object.keys(memory).filter(key => key.endsWith('/'));
			};

			// Get the current path
			const currentPath = "Downloads/";

			// Get folder names array
			let folders = getFolderNames(memory);
			let filteredFolders = folders.filter(folder => folder !== currentPath);

			// Create select element
			let selectOptions = filteredFolders.map(folder => `<option>${folder}</option>`).join('');
			let selectElement = `<select id="filesappselecttomovedest">${selectOptions}</select>`;

			// Ask user to select a folder
			let confpromise = await window.parent.justConfirm("Select a folder", `Move to ${selectElement}`);

			console.log("promise result: " + confpromise);
			if (confpromise) {
				let selectedFolder = window.parent.document.getElementById("filesappselecttomovedest").value;
				console.log("Moving to: " + selectedFolder);

				// Function to find a file by ID
				const getFileById = (memory, id) => {
					for (let folder in memory) {
						for (let file in memory[folder]) {
							if (memory[folder][file].id === id) {
								return { path: folder, name: file, data: memory[folder][file] };
							}
						}
					}
					return null;
				};

				// Get file data by ID
				let fileData = getFileById(memory, flid);
				if (fileData) {
					// Create file in the new location
					memory[selectedFolder][fileData.name] = fileData.data;
					console.log("file made in " + selectedFolder + ", " + JSON.stringify(fileData.data));

					// Remove file from the old location
					delete memory[fileData.path][fileData.name];
					console.log("removing: " + flid);

					document.getElementById("fileinfobn").innerHTML = "File was moved to " + selectedFolder;
				} else {
					console.error("File not found!");
				}
			}
		}


		const databaseName = 'trojencat';
		// Function to open or create an IndexedDB database
		function openDB(databaseName, version) {
			return new Promise((resolve, reject) => {
				const request = indexedDB.open(databaseName, version);

				request.onupgradeneeded = (event) => {
					const db = event.target.result;
					if (!db.objectStoreNames.contains('store')) {
						db.createObjectStore('store', { keyPath: 'key' });
					}
				};

				request.onsuccess = (event) => {
					const db = event.target.result;

					resolve(db);
				};

				request.onerror = () => {
					reject(request.error);
				};
			});
		}

		function geticon(x) {
			let i, c;
			if (x == "txt") {
				i = "description"
				c = "#42A5F5"
			} else if (x == "app") {
				i = "rocket_launch"
				c = "#4CAF50"
			} else if (window.parent.getbaseflty(x) == "image") {
				i = "image"
				c = "#FFEE58"
			} else if (window.parent.getbaseflty(x) == "music") {
				i = "graphic_eq"
				c = "violet"
			} else if (window.parent.getbaseflty(x) == "video") {
				i = "videocam"
				c = "lightblue"
			} else if (x == "json") {
				i = "data_object"
				c = "red"
			} else if (x == "lnk") {
				i = "reply"
				c = "green"
			} else if (window.parent.getbaseflty(x) == "code") {
				i = "developer_board"
				c = "#hh83j2"
			} else if (x == "folder") {
				i = "folder"
				c = "#FDD835"
			} else {
				i = "bug_report"
			}
			return `<span class="material-symbols-rounded" style="color:` + c + `">
		`+ i + `
		</span>`
		}

		function getfolicon(x) {
			const iconMap = {
				"Downloads": "fas fa-download",
				"Desktop": "fas fa-desktop",
				"Apps": "fas fa-shapes",
				"System": "fas fa-gear",
				"Dock": "fas fa-rocket",
				"Media": "fas fa-play-circle",
				"Documents": "fas fa-file",
				"Favorites": "fas fa-heart"
			};

			for (const key in iconMap) {
				if (x.startsWith(key)) {
					return iconMap[key];
				}
			}
			return "fas fa-folder";
		}


		function upmd() {
			document.getElementById("fupibu").innerHTML = "Import";

			document.getElementById("fupibu").onclick = fupit;
			document.getElementById("upmod").showModal();
		}

		document.addEventListener('dbchange', async () => {
			await window.parent.updateMemoryData();
			refresh();
		});

		function changeview(how) {
			flmode = how;
			listFiles(currentPath)
		}

		async function remfold() {
			if (currentPath == "System") {
				window.parent.say("You cannot remove system folder through files app.")
			}
			let x = await window.parent.justConfirm("Remove folder?", "Remove '" + currentPath + "' permanently from your device?")
			if (x) {
				await window.parent.remfolder(currentPath).then(function () {
					document.getElementById("fileinfobn").innerHTML = currentPath + " was removed"
				})
				listFiles('', true)
			}
		}


		function mtpetxt(str) {
			try {
				const parts = str.split('/');
				return parts.length > 1 ? parts.pop() : '';
			} catch (err) {
				console.log(err)
			}
		}

		function ptypext(str) {
			try {
				const parts = str.split('.');
				return parts.length > 1 ? parts.pop() : '';
			} catch (err) {
				console.log(err)
			}
		}
		greenflagbro()
	</script>
</body>

</html>