<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Nova OS Claw</title>
    <link rel="stylesheet" href="style.css">
    </script>
    <!--ion icons-->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300&display=swap');

        :root {
            --sizing-huge: 1rem;
            --sizing-normal: 0.5rem;
            --sizing-nano: 0.3rem;

            --vw: 1vw;
            --vh: 1vh;
            --font-size-default: calc((var(--vw) + var(--vh)) / 2);
        }

        ::-webkit-scrollbar {
            width: 0.5rem;
        }

        ::-webkit-scrollbar-track {
            background: #101010;
            border-radius: 0.5rem;
        }

        ::-webkit-scrollbar-thumb {
            background: #1f1f1f;
            border-radius: 0.5rem;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2f2f2f;
            cursor: grab;
        }

        ::-webkit-scrollbar-thumb:active {
            cursor: grabbing;
        }

        html {
            height: 100%;
            width: 100%;
            font-size: var(--font-size);
        }

        button,
        input,
        textarea {
            outline: none;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
        }

        button {
            cursor: pointer;
        }

        body {
            padding: 0.3rem;
            background-color: #101010;
            color: white;
            font-family: 'Poppins', sans-serif;
            user-select: none;
            height: calc(100% - 2rem);
        }

        #main {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            height: 100%;
            gap: 0.5rem;
        }

        #main #feedsection,
        #main #toolsection {
            width: 0;
        }

        #main #feedsection {
            flex: 3;
            display: flex;
            flex-direction: column;
        }

        #main #toolsection {
            flex: 1;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .searchsection {
            display: flex;
            flex-direction: row;
            background: #1f1f1f;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 0.7rem;
        }

        input#searchinput {
            width: 0;
            flex: 1;
            border: none;
            background-color: transparent;
        }

        .searchsection button {
            background: transparent;
            border: none;
            padding: 0;
            color: inherit;
            opacity: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .navtools {
            background: #1f1f1f;
            padding: 0.3rem;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        #feed {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            gap: 0.5rem;
            flex: 1;
            padding: 0.3rem;
        }

        .randompost {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background: #1f1f1f;
            padding: 1rem;
            border-radius: 0.5rem;
            animation: msgpop .3s ease-out;
        }

        @keyframes msgpop {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-5px);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }

        .more {
            opacity: 0;
            transition: .3s;
        }

        .randompost:hover .more {
            opacity: 0.7;
        }

        .postuserdata {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
        }

        .postuseravatar {
            width: 40px;
            height: 40px;
            aspect-ratio: 1 / 1;
            overflow: hidden;
        }

        .postuseravatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1rem;
        }

        .postfooter {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            align-items: center;
        }

        .postfooter .likes ion-icon {
            color: #ff9a9a;
        }

        .postcontent {
            font-size: 110%;
            margin: 0.7rem 0px;
        }

        .more button {
            border-radius: 10px;
            padding: 4px 10px;
            background: #161616;
            border: none;
            color: inherit;
            font-size: 80%;
        }

        .likes {
            background: #161616;
            display: flex;
            padding: 5px 8px;
            border-radius: 0.5rem;
            cursor: pointer;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }

        span.likesnumber {
            font-size: 80%;
        }

        .posttimestamp {
            font-size: 80%;
            opacity: 70%;
        }

        .quotebtn {
            background-color: #4e5fa7 !important;
        }

        nav#nav {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            opacity: 0.7;
            padding: 10px;
        }

        #postinput {
            background: #1f1f1f;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: none;
            width: calc(100% - 1rem);
            min-width: 0;
            max-height: 70vh;
            font-size: 130%;
            height: 150px;
            resize: vertical;
        }

        .postmsgsection {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        button.postbtn {
            background: #4e5fa7;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 4px;
            border: none;
            padding: 3px 10px;
            border-radius: 0.5rem;
            padding-right: 5px;
        }

        .feedsbtn {
            color: white;
            overflow: hidden;
        }

        .feedsbtn button {
            background-color: transparent;
            border-radius: 0.5rem;
            border: none;
        }

        .feedsbtn button.current {
            background-color: #1f1f1f;
        }
    </style>
</head>

<body>
    <main id="main">
        <div id="feedsection">
            <nav id="nav">
                <span class="logo">
                    NovaOS Claw
                </span>
                <div class="feedsbtn">
                    <button class="current" onclick="loadFeed('main')">Main</button>
                    <button onclick="loadFeed('following')">Following</button>
                </div>
                <div class="navtools" onclick="loadFeed('current')">
                    <ion-icon name="arrow-up-circle-outline" title="Refresh feed"></ion-icon>
                </div>
            </nav>
            <div id="feed">

            </div>
        </div>
        <div id="toolsection">
            <div class="searchsection">
                <input id="searchinput" placeholder="Search posts...">
                <button onclick="searchclaw()">
                    <ion-icon name="search-outline"></ion-icon>
                </button>
            </div>
            <div class="postmsgsection">
                <textarea id="postinput" placeholder="What is going on!?"></textarea>
                <button onclick="newpost()" class="postbtn">
                    <span>Post</span>
                    <ion-icon name="chevron-forward-outline"></ion-icon>
                </button>
            </div>
        </div>
    </main>

    <script>
        async function loadFeed(feedtype) {
            var response;
            if (feedtype == "following") {
                if (!checkifaccs()) { return }
                 response = await fetch("https://claw.rotur.dev/following?limit=10&auth="+ window.parent.roturExtension.userToken);
            } else {
                 response = await fetch("https://claw.rotur.dev/feed?limit=10");
            }
            const posts = await response.json();
            const feedContainer = document.getElementById("feed");
            feedContainer.innerHTML = "";

            const wordFrequency = new Map();

            posts.forEach(post => {
                const postElement = document.createElement("div");
                postElement.classList.add("randompost");

                const postNav = document.createElement("div");
                postNav.classList.add("postnav");

                const postUserData = document.createElement("div");
                postUserData.classList.add("postuserdata");

                const postUserAvatar = document.createElement("div");
                postUserAvatar.classList.add("postuseravatar");

                const userAvatarImg = document.createElement("img");
                userAvatarImg.classList.add("postuseravatarsrc");
                userAvatarImg.src = post.pfp;

                postUserAvatar.appendChild(userAvatarImg);

                const postUserDynamics = document.createElement("div");
                postUserDynamics.classList.add("postuserdynamics");

                const postUsername = document.createElement("div");
                postUsername.classList.add("postusername");
                postUsername.textContent = post.user;

                const postTimestamp = document.createElement("div");
                postTimestamp.classList.add("posttimestamp");
                postTimestamp.textContent = timeSince(post.timestamp) + ((post.os) ? (" | Posted on " + post.os) : "");

                postUserDynamics.appendChild(postUsername);
                postUserDynamics.appendChild(postTimestamp);

                postUserData.appendChild(postUserAvatar);
                postUserData.appendChild(postUserDynamics);

                postNav.appendChild(postUserData);
                postElement.appendChild(postNav);

                const postContent = document.createElement("div");
                postContent.classList.add("postcontent");
                postContent.textContent = post.content;
                postElement.appendChild(postContent);

                // Update word frequency
                const words = post.content.split(/\W+/).filter(word => word.length > 3);
                words.forEach(word => {
                    const lowerWord = word.toLowerCase();
                    wordFrequency.set(lowerWord, (wordFrequency.get(lowerWord) || 0) + 1);
                });

                const postFooter = document.createElement("div");
                postFooter.classList.add("postfooter");

                const likesDiv = document.createElement("div");
                likesDiv.classList.add("likes");
                likesDiv.onclick = function () {
                    likepost(post.id);
                };

                const heartIcon = document.createElement("ion-icon");
                heartIcon.setAttribute("name", "heart-outline");

                const likesNumber = document.createElement("span");
                likesNumber.classList.add("likesnumber");
                likesNumber.textContent = post.likes ? post.likes.length : 0;

                likesDiv.appendChild(heartIcon);
                likesDiv.appendChild(likesNumber);

                const moreDiv = document.createElement("div");
                moreDiv.classList.add("more");

                const copyButton = document.createElement("button");
                copyButton.textContent = "Copy ID";
                copyButton.onclick = function () {
                    copyId(post.id);
                };

                const quoteButton = document.createElement("button");
                quoteButton.classList.add("quotebtn");
                quoteButton.textContent = "Quote";

                moreDiv.appendChild(copyButton);
                moreDiv.appendChild(quoteButton);

                postFooter.appendChild(likesDiv);
                postFooter.appendChild(moreDiv);
                postElement.appendChild(postFooter);

                feedContainer.appendChild(postElement);
            });

            // Calculate top 5 hot words
            const hotWords = Array.from(wordFrequency.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => entry[0]);

            console.log("Top 5 hot words:", hotWords);
        }


        async function likepost(id) {
            await fetch("https://claw.rotur.dev/rate?id=" + id + "&auth=" +
                window.parent.roturExtension.userToken + "&rating=1&os=novaOS");
            loadFeed()
        }

        async function newpost() {
            if (!checkifaccs()) { return }
            let content = document.getElementById("postinput").value;
            await fetch("https://claw.rotur.dev/post?content=" + content + "&os=novaOS&auth=" +
                window.parent.roturExtension.userToken);
            loadFeed()
        }

        function timeSince(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            const intervals = [
                { label: 'year', seconds: 31536000 },
                { label: 'month', seconds: 2592000 },
                { label: 'day', seconds: 86400 },
                { label: 'hour', seconds: 3600 },
                { label: 'minute', seconds: 60 },
            ];
            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.seconds);
                if (count >= 1) return `${count} ${interval.label}${count !== 1 ? 's' : ''} ago`;
            }
            return "Just now";
        }

        function copyId(id) {
            navigator.clipboard.writeText(id);
        }

        function checkifaccs() {
            let signedinch = window.parent.roturExtension.loggedIn();
            if (!signedinch) {
                window.parent.say("You don't have a rotur account linked.")
            }
            return signedinch;
        }

        loadFeed();
    </script>
</body>

</html>